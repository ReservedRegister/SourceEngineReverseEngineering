name: build

on: [push]

jobs:
  build:
    runs-on: ubuntu-20.04
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}      
    steps:
      - name: Prepare env
        shell: bash
        run: |
          echo "GITHUB_SHA_SHORT=${GITHUB_SHA::7}" >> $GITHUB_ENV
          
      - name: Install packages
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y clang g++-multilib
          echo "CC=clang" >> $GITHUB_ENV
          echo "CXX=clang++" >> $GITHUB_ENV
          
      - name: Setup sourcemod & HL2SDK
        run: |
          git clone --recursive https://github.com/alliedmodders/sourcemod
          bash sourcemod/tools/checkout-deps.sh
          
      - name: Setting up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Getting ambuild
        run: |
          python -m pip install wheel
          pip install git+https://github.com/alliedmodders/ambuild
          
      - name: Getting own repository
        uses: actions/checkout@v4
        with:
          path: extension
          
      - name: Compiling ${{ github.event.repository.name }} files
        working-directory: extension
        run: |
          mkdir build
          cd build
          python ../configure.py
          ambuild
          
      - name: Uploading package
        uses: actions/upload-artifact@v4
        with:
          name: synergy_utils
          path: extension/build/package
          
      - name: Release with Notes
        uses: softprops/action-gh-release@v1
        with:
          tag_name: Release
          files: |
            extension/build/package/addons/sourcemod/extensions/synergy_utils.ext2.sdk2013.so
